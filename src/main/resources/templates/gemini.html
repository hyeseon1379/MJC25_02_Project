<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gemini 테스트</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/css/output.css" rel="stylesheet" th:href="@{/css/output.css}">
</head>
<body class="bg-gray-100 min-h-screen p-6">

<div class="max-w-md mx-auto bg-white p-6 rounded shadow space-y-4">
    <h1 class="text-xl font-bold text-center text-gray-800">Gemini 간단 테스트</h1>

    <!-- 입력 폼 -->
    <form id="chat-form" class="flex gap-2">
        <input type="text" id="chat-input" class="flex-1 border rounded p-2" placeholder="질문 입력..." required>
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">보내기</button>
    </form>

    <!-- 채팅 박스 -->
    <div id="chat-box" class="h-64 overflow-y-auto border rounded p-3 bg-gray-50 space-y-2 text-sm">
        <!-- 메시지 출력됨 -->
    </div>
</div>

<script th:inline="javascript">
    const form = document.getElementById("chat-form");
    const input = document.getElementById("chat-input");
    const chatBox = document.getElementById("chat-box");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const userMsg = input.value.trim();
        if (!userMsg) return;

        appendMessage("나", userMsg);
        input.value = "";

        try {
            const res = await fetch(/*[[${'/gemini/simple'}]]*/ "/gemini/simple", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(userMsg)
            });

            const data = await res.text();
            let reply = "(응답 형식이 이상합니다)";
            try {
                const json = JSON.parse(data);
                const text = json.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) reply = text;
            } catch (err) {
                reply = "(JSON 파싱 실패)";
            }
            appendMessage("Gemini", reply);
        } catch (err) {
            appendMessage("Gemini", "(에러 발생: " + err.message + ")");
        }
    });

    appendMessage("Gemini", reply);
    function appendMessage(sender, message) {
        const div = document.createElement("div");
        div.innerHTML = `<strong>${sender}:</strong> <div class="whitespace-pre-line">${message}</div>`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>

</body>
</html>